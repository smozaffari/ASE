---
title: "SignTest_ImprintedGene"
author: "Sahar Mozaffari"
date: "4/23/2018"
output:
  pdf_document: default
  html_document: default
---

###Testing for significant difference between maternal and paternal expression for genes across all individuals.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 3)
library(qqman)
library(ggsci)
library(ggplot2)
library(qvalue)
library(cowplot)


library(doParallel)
library(foreach)
require(doParallel)
require(foreach)

registerDoParallel()
getDoParWorkers()
theme_set(theme_cowplot(font_size = 18, line_size = 1))
```
Read in not normalized maternal and paternal expression matrixes. 
Remove genes that are not expressed in maternal or paternal, and remove those genes expressed in less than 100 reads summed over all maternal and paternal for that gene.

```{r genetest, echo=FALSE, include=FALSE}
newmat2 <- read.table("~/Documents/POexpressionpaper/Analyses/Data/Maternal_gene_notnormalized_nodup_v19_20180423.txt", check.names = F)
newpat2 <- read.table("~/Documents/POexpressionpaper/Analyses/Data/Paternal_gene_notnormalized_nodup_v19_20180423.txt", check.names = F)
CS <- read.table("~/Documents/POexpressionpaper/Analyses/Data/CS_04.23.txt", check.names=F)
touse <- read.table("~/Documents/POexpressionpaper/Analyses/Data/findivs_touse_triosLCL")
newmat1 <- newmat2[,which(colnames(newmat2)%in%touse$V1),]
newpat1 <- newpat2[,which(colnames(newpat2)%in%touse$V1),]


pat0 <- which(rowSums(newpat1)==0)
mat0 <- which(rowSums(newmat1)==0)
both0 <- which(pat0%in%mat0)
newmat4 <- newmat1[-both0,]
newpat4 <- newpat1[-both0,]
dim(newmat4)


both <- which(colSums(rbind(rowSums(newpat4)), rowSums(newmat4))>100)
newpat3 <- newpat4[both,]
newmat3 <- newmat4[both,]
genes <- rownames(newpat3)
dim(newmat3)
```




```{r genes, echo=FALSE}
ensGene <- read.table("~/Documents/POexpressionpaper/Analyses/Data/ensGene.txt-2")
genenames <- read.table("~/Documents/POexpressionpaper/Analyses/Data/ensemblToGeneName.txt")

ensGene2 <- ensGene[,c("V2", "V13")]
genenames2 <- merge(genenames, ensGene2, by.x="V1", by.y="V2")
genenames2 <- unique(genenames2[,c(2,3)])

```

```{r imprintedgenes, echo=FALSE}
supp <- read.csv("~/Documents/POexpressionpaper/Analyses/Data/supp4", header = T)

```


```{r signtest, echo=FALSE}

Zsign <- c()
Z2 <- c()
Zsign <- foreach(i=1:dim(newmat3)[1], .combine=rbind ) %dopar% {
  n5 <- which((newpat3[i,]+newmat3[i,])>5)
  Spp <- c()
  if (length(n5 >5)) {
    for (k in 1:length(n5)) {
      j <- n5[k]
      Z=(newpat3[i,j]-newmat3[i,j])/(sqrt(newpat3[i,j]+newmat3[i,j]))
      if (Z!=0){
        Spp <- c(Spp,Z)
      }
    }
  } 
  if (length(Spp)>0){
    s <- binom.test(length(which(Spp>0)), length(Spp), 0.5)
    list(length(which(Spp<0)),  length(which(Spp>0)), s$p.value)
  } else {
    list("NA", "NA", "NA")
  }
}

Zsign2 <- as.data.frame(Zsign)
colnames(Zsign2) <- c("less0", "greater0", "signpvalue")
Zsign2$genes <- genes
Zsign3 <- merge(Zsign2, genenames2, by.x="genes", by.y="V13")


Zall3 <- Zsign3
Zall3$signFDR <- qvalue(as.numeric(as.character(Zall3$signpval)))$qvalues

x <- apply(head(Zall3[order(Zall3$signFDR),],28), 2,as.character)
write.table(x, "Zall3.txt", col.names=T, row.names=F, quote=F)
head(x)
